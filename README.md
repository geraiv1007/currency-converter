# Конвертер валют
Данный проект представляет собой стандартный конвертер валют с получением актуальных и исторических курсов валют, динамики изменения курсов валют и стандартной конвертации пары валют.\
В качестве API использован https://apilayer.com/marketplace/currency_data-api
## Стек
- **FastAPI** — основной web-фреймворк
- **Pydantic** — валидация данных
- **pydantic-settings** — управление конфигурацией через переменные окружения
- **PostgreSQL** — основная база данных
- **Redis** — кэширование данных
- **Kafka** — брокер сообщений
- **SQLAlchemy** — ORM для взаимодействия с БД
- **Alembic** — миграции схемы БД
## Требования
Для корректной работы требуется python 3.12. Необходимые библиотеки указаны в файле **poetry.lock**.\
Переменные окружения извлекаются **только из файлов currency.env и mail.env** в корневой папке проекта.\
Для примера приложены файлы **currency.env.example и mail.env.example**, где указаны необходимые переменные окружения.
## Описание
### Авторизация
Авторизация реализована через связку access и refresh токенов. По истечению срока жизни access токена\
необходимо передать на эндпойнт `'/refresh_tokens'` refresh токен и получить новую пару токенов.

Токены необходимо передавать в заголовках запроса:
- access токен в заголовке **Authorization** в формате `{'Authorization': 'bearer <токен>'}`
- refresh токен в заголовке **X-Refresh-Token** в формате `{'X-Refresh-Token': '<токен>'}`

Логин возможен тремя способами:
1. `'/login'` стандартный логин через username и password
2. `'/login/google'` внешняя аутентификация через oauth google
3. `'/login/yandex'` внешняя аутентификация через oauth yandex
### Основные функции
Доступны следующие эндпойнты:
1. `'/currency/list'`\
   Получение списка всех валют
2. `'/currency/convert'`\
   Конвертация определенного количества одной валюты в другую на конкретную дату
3. `'/currency/exchange_rate/live'`\
   Получение наиболее актуального курса одной и более валют по отношению к исходной
4. `'/currency/exchange_rate/hist'`\
   Получение курса одной и более валют по отношению к исходной на определенную дату
5. `'/currency/exchange_rate/change'`\
   Получение динамики курса одной и более валют по отношению к исходной за указанный промежуток времени
6. `'/currency/exchange_rate/daily'`\
    Получение ежедневного курса одной и более валют по отношению к исходной за указанный промежуток времени (не более 365 дней)
### Отправка писем
Отдельным сервисом реализована возможность отправки email писем на указанный при регистрации адрес. Для всех эндпойнтов\
`/currency/exchange/*` добавлен параметр **send_email**, который отвечает за необходимость отправки полученного json\
с информацией о валютах по email. Письмо направляется в удобно читаемом табличном формате с csv дополнительно во вложении.

## Запуск

Для запуска приложения в Docker контейнере в корневой папке проекта расположены **Dockerfile** и **docker-compose.yml**.\
Необходимо скопировать все файлы в локальную директорию и заполнить файл .env. Переменные DB__HOST и CACHE__HOST должны иметь\
значения согласно названию сервисов в docker compose файле, т.е. db и cache соответственно.

Пример заполнения
```
# DB
DB__DIALECT=postgresql
DB__DRIVER=asyncpg
DB__USERNAME=<юзер из переменной POSTGRES_USER>
DB__PASSWORD=<пароль из переменной POSTGRES_PASSWORD>
DB__HOST=db
DB__PORT=5432
DB__DATABASE=<название БД из переменной POSTGRES_DB>

# CACHE
CACHE__HOST=cache
CACHE__PORT=6379
CACHE__DB=0
```
Далее необходимо запустить в корневой папке проекта в консоли команду `'docker compose up -d'`\
После создания всех сервисов приложение будет доступно по адресу `localhost:8000/docs`
